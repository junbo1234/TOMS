<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>标签页系统测试</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- 自定义样式 -->
    <link rel="stylesheet" href="/static/CSS/style.css">
    <style>
        .test-info {
            background-color: #f8f9fa;
            padding: 1rem;
            border-radius: 0.5rem;
            margin-bottom: 1rem;
            border-left: 4px solid #0d6efd;
        }
        .test-case {
            margin-bottom: 2rem;
            padding: 1.5rem;
            border: 1px solid #dee2e6;
            border-radius: 0.5rem;
        }
        .test-case h3 {
            margin-bottom: 1rem;
            color: #0d6efd;
        }
        .status {
            padding: 0.25rem 0.75rem;
            border-radius: 1rem;
            font-weight: bold;
        }
        .status.passed {
            background-color: #d1e7dd;
            color: #0f5132;
        }
        .status.failed {
            background-color: #f8d7da;
            color: #842029;
        }
        .test-results {
            margin-top: 2rem;
            padding: 1.5rem;
            background-color: #f8f9fa;
            border-radius: 0.5rem;
        }
        .test-nav {
            margin-bottom: 1rem;
        }
    </style>
</head>
<body>
    <div class="container mt-5">
        <h1 class="text-center mb-5">标签页系统功能测试</h1>
        
        <div class="test-info">
            <h3><i class="fas fa-info-circle"></i> 测试说明</h3>
            <p>此页面用于全面测试标签页系统功能，包括多个二级菜单标签页的创建、激活、关闭等操作。请按照以下测试用例逐一验证功能是否正常工作。</p>
        </div>

        <!-- 测试用例区域 -->
        <div class="test-case">
            <h3>测试用例 1: 基本标签页创建</h3>
            <p>验证点击二级菜单项能否成功创建新的标签页。</p>
            <div class="test-nav">
                <button class="btn btn-primary test-btn" data-test="create-tab">
                    <i class="fas fa-plus"></i> 测试创建标签页
                </button>
            </div>
            <div id="create-tab-result" class="mt-2">
                <span class="status">测试未执行</span>
            </div>
        </div>

        <div class="test-case">
            <h3>测试用例 2: 多个标签页创建</h3>
            <p>验证能否同时创建并管理多个不同的二级菜单标签页。</p>
            <div class="test-nav">
                <button class="btn btn-primary test-btn" data-test="multiple-tabs">
                    <i class="fas fa-layer-group"></i> 测试多个标签页
                </button>
            </div>
            <div id="multiple-tabs-result" class="mt-2">
                <span class="status">测试未执行</span>
            </div>
        </div>

        <div class="test-case">
            <h3>测试用例 3: 防止重复创建标签页</h3>
            <p>验证点击同一个二级菜单项多次，不会重复创建标签页，而是激活已有标签页。</p>
            <div class="test-nav">
                <button class="btn btn-primary test-btn" data-test="duplicate-tab">
                    <i class="fas fa-check-circle"></i> 测试重复点击
                </button>
            </div>
            <div id="duplicate-tab-result" class="mt-2">
                <span class="status">测试未执行</span>
            </div>
        </div>

        <div class="test-case">
            <h3>测试用例 4: 标签页关闭功能</h3>
            <p>验证标签页关闭按钮能否正常工作，以及首页标签是否受到保护。</p>
            <div class="test-nav">
                <button class="btn btn-primary test-btn" data-test="close-tab">
                    <i class="fas fa-times-circle"></i> 测试关闭标签页
                </button>
            </div>
            <div id="close-tab-result" class="mt-2">
                <span class="status">测试未执行</span>
            </div>
        </div>

        <!-- 测试结果汇总 -->
        <div class="test-results">
            <h3 class="text-center mb-3">测试结果汇总</h3>
            <div class="row">
                <div class="col-md-6">
                    <p><strong>通过测试:</strong> <span id="passed-count">0</span></p>
                </div>
                <div class="col-md-6">
                    <p><strong>失败测试:</strong> <span id="failed-count">0</span></p>
                </div>
            </div>
            <div class="text-center mt-3">
                <button class="btn btn-success" id="run-all-tests">
                    <i class="fas fa-play"></i> 运行所有测试
                </button>
                <button class="btn btn-secondary ml-2" id="reset-tests">
                    <i class="fas fa-redo"></i> 重置测试
                </button>
            </div>
        </div>
    </div>

    <!-- 标签页系统模拟区域 -->
    <div class="container mt-5">
        <!-- Tab Navigation -->
        <ul class="nav nav-tabs" id="tabNav" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="home-tab" data-bs-toggle="tab" data-bs-target="#tab-home" type="button" role="tab">
                    <i class="fas fa-home me-1"></i>仪表盘
                </button>
            </li>
        </ul>

        <!-- Tab Content -->
        <div class="tab-content" id="tabContent">
            <div class="tab-pane fade show active" id="tab-home" role="tabpanel">
                <div class="p-4">
                    <h2>欢迎使用标签页系统测试</h2>
                    <p>此区域用于显示标签页内容。请使用上方的测试用例按钮来测试标签页系统的各种功能。</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- 标签页管理系统 -->
    <script>
        // 标签页管理 - 在全局作用域定义，确保所有函数都能访问
        let tabNav, tabContent, activeTabs;
        
        // 确保在DOM加载完成后执行
        document.addEventListener('DOMContentLoaded', function() {
            // 获取标签页容器元素
            tabNav = document.getElementById('tabNav');
            tabContent = document.getElementById('tabContent');
            activeTabs = new Set();
            
            // 菜单名称映射
            const menuNames = {
                'home': '仪表盘',
                'order_download': '订单下载',
                'order_delivery': '订单发货',
                'refund_order': '退款单生成',
                'exchange_order': '换货单生成',
                'return_order_notice': '通知单入库',
                'stockout_push': '出库单推送',
                'return_order_entry': '退货单入库',
                'allocation_out': '调拨出库',
                'allocation_in': '调拨入库',
                'inventory_adjust': '库存调整',
                'inventory_out': '其他出库',
                'inventory_entry': '其他入库',
                'report_out': '报表出库'
            };
            
            // 创建新标签页
            function createTab(pageKey, pageTitle, url) {
                if (activeTabs.has(pageKey)) {
                    // 如果标签页已存在，激活它
                    activateTab(pageKey);
                    return true;
                }
                
                activeTabs.add(pageKey);
                
                // 创建标签按钮
                const tabButton = document.createElement('li');
                tabButton.className = 'nav-item';
                tabButton.setAttribute('role', 'presentation');
                tabButton.innerHTML = `
                    <button class="nav-link" id="${pageKey}-tab" data-bs-toggle="tab" 
                            data-bs-target="#tab-${pageKey}" type="button" role="tab">
                        <i class="fas fa-spinner fa-spin me-1"></i>${pageTitle}
                        <button class="close-tab-btn ms-2" data-page="${pageKey}">&times;</button>
                    </button>
                `;
                
                // 创建标签内容
                const tabPane = document.createElement('div');
                tabPane.className = 'tab-pane fade';
                tabPane.id = `tab-${pageKey}`;
                tabPane.setAttribute('role', 'tabpanel');
                
                // 添加到DOM
                if (tabNav && tabContent) {
                    tabNav.appendChild(tabButton);
                    tabContent.appendChild(tabPane);
                } else {
                    console.error('标签页容器元素未找到');
                    return false;
                }
                
                // 填充模拟内容
                setTimeout(() => {
                    tabPane.innerHTML = `
                        <div class="p-4">
                            <h2>${pageTitle}</h2>
                            <p>这是${pageTitle}页面的模拟内容。</p>
                            <p class="text-muted">页面ID: ${pageKey}</p>
                        </div>
                    `;
                    // 移除加载动画
                    const spinner = tabButton.querySelector('.fa-spinner');
                    if (spinner) spinner.remove();
                }, 300);
                
                // 添加关闭按钮事件
                tabButton.querySelector('.close-tab-btn').addEventListener('click', function(e) {
                    e.stopPropagation();
                    closeTab(pageKey);
                });
                
                // 激活新创建的标签
                activateTab(pageKey);
                return true;
            }
            
            // 激活标签页
            function activateTab(pageKey) {
                // 移除所有激活状态
                const allTabs = tabNav.querySelectorAll('.nav-link');
                allTabs.forEach(tab => tab.classList.remove('active'));
                
                const allPanes = tabContent.querySelectorAll('.tab-pane');
                allPanes.forEach(pane => {
                    pane.classList.remove('show', 'active');
                });
                
                // 激活指定标签页
                const activeTab = document.getElementById(`${pageKey}-tab`);
                const activePane = document.getElementById(`tab-${pageKey}`);
                
                if (activeTab && activePane) {
                    activeTab.classList.add('active');
                    activePane.classList.add('show', 'active');
                }
            }
            
            // 关闭标签页
            function closeTab(pageKey) {
                if (pageKey === 'home') {
                    return; // 首页标签不能关闭
                }
                
                activeTabs.delete(pageKey);
                
                // 移除标签按钮和内容
                const tabButton = document.getElementById(`${pageKey}-tab`);
                const tabPane = document.getElementById(`tab-${pageKey}`);
                
                if (tabButton && tabPane) {
                    tabButton.closest('li').remove();
                    tabPane.remove();
                    
                    // 如果关闭的是当前激活的标签页，激活首页
                    const activeTab = tabNav.querySelector('.nav-link.active');
                    if (!activeTab) {
                        activateTab('home');
                    }
                }
            }
            
            // 测试用例实现
            const testCases = {
                'create-tab': function() {
                    const resultEl = document.getElementById('create-tab-result');
                    const success = createTab('test_order1', '测试订单1', '/test/order1');
                    
                    if (success) {
                        resultEl.innerHTML = '<span class="status passed">通过</span>: 标签页创建成功';
                        return true;
                    } else {
                        resultEl.innerHTML = '<span class="status failed">失败</span>: 标签页创建失败';
                        return false;
                    }
                },
                
                'multiple-tabs': function() {
                    const resultEl = document.getElementById('multiple-tabs-result');
                    
                    // 创建多个标签页
                    const success1 = createTab('test_order2', '测试订单2', '/test/order2');
                    const success2 = createTab('test_refund', '测试退款', '/test/refund');
                    const success3 = createTab('test_stock', '测试库存', '/test/stock');
                    
                    if (success1 && success2 && success3) {
                        resultEl.innerHTML = '<span class="status passed">通过</span>: 多个标签页创建成功';
                        return true;
                    } else {
                        resultEl.innerHTML = '<span class="status failed">失败</span>: 多个标签页创建失败';
                        return false;
                    }
                },
                
                'duplicate-tab': function() {
                    const resultEl = document.getElementById('duplicate-tab-result');
                    
                    // 第一次创建
                    const success1 = createTab('test_duplicate', '测试重复', '/test/duplicate');
                    
                    // 记录当前标签数量
                    const initialTabCount = activeTabs.size;
                    
                    // 第二次尝试创建相同的标签页
                    const success2 = createTab('test_duplicate', '测试重复', '/test/duplicate');
                    
                    // 验证标签数量没有增加
                    const finalTabCount = activeTabs.size;
                    
                    if (success1 && success2 && initialTabCount === finalTabCount) {
                        resultEl.innerHTML = '<span class="status passed">通过</span>: 防止重复创建功能正常';
                        return true;
                    } else {
                        resultEl.innerHTML = '<span class="status failed">失败</span>: 防止重复创建功能异常';
                        return false;
                    }
                },
                
                'close-tab': function() {
                    const resultEl = document.getElementById('close-tab-result');
                    
                    // 创建一个测试标签页
                    createTab('test_close', '测试关闭', '/test/close');
                    
                    // 记录初始标签数量
                    const initialTabCount = activeTabs.size;
                    
                    // 关闭标签页
                    closeTab('test_close');
                    
                    // 验证标签数量减少
                    const finalTabCount = activeTabs.size;
                    
                    // 尝试关闭首页标签
                    closeTab('home');
                    const homeStillExists = activeTabs.has('home');
                    
                    if (finalTabCount === initialTabCount - 1 && homeStillExists) {
                        resultEl.innerHTML = '<span class="status passed">通过</span>: 标签页关闭功能正常，首页标签受到保护';
                        return true;
                    } else {
                        resultEl.innerHTML = '<span class="status failed">失败</span>: 标签页关闭功能异常';
                        return false;
                    }
                }
            };
            
            // 测试按钮事件
            document.querySelectorAll('.test-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const testName = this.getAttribute('data-test');
                    const testFunc = testCases[testName];
                    
                    if (testFunc) {
                        const result = testFunc();
                        updateTestSummary(result);
                    }
                });
            });
            
            // 运行所有测试
            document.getElementById('run-all-tests').addEventListener('click', function() {
                let passed = 0;
                let failed = 0;
                
                // 重置所有测试结果
                document.querySelectorAll('[id$="-result"]').forEach(el => {
                    el.innerHTML = '<span class="status">测试未执行</span>';
                });
                
                // 运行每个测试用例
                for (const testName in testCases) {
                    const result = testCases[testName]();
                    if (result) passed++;
                    else failed++;
                }
                
                // 更新汇总
                document.getElementById('passed-count').textContent = passed;
                document.getElementById('failed-count').textContent = failed;
            });
            
            // 重置测试
            document.getElementById('reset-tests').addEventListener('click', function() {
                // 关闭所有非首页标签
                activeTabs.forEach(tabKey => {
                    if (tabKey !== 'home') {
                        closeTab(tabKey);
                    }
                });
                
                // 重置测试结果
                document.querySelectorAll('[id$="-result"]').forEach(el => {
                    el.innerHTML = '<span class="status">测试未执行</span>';
                });
                
                // 重置汇总
                document.getElementById('passed-count').textContent = '0';
                document.getElementById('failed-count').textContent = '0';
                
                // 激活首页
                activateTab('home');
            });
            
            // 更新测试汇总
            function updateTestSummary(result) {
                const passedEl = document.getElementById('passed-count');
                const failedEl = document.getElementById('failed-count');
                
                let passed = parseInt(passedEl.textContent);
                let failed = parseInt(failedEl.textContent);
                
                if (result) {
                    passed++;
                } else {
                    failed++;
                }
                
                passedEl.textContent = passed;
                failedEl.textContent = failed;
            }
        });
    </script>
</body>
</html>